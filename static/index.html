<!DOCTYPE html>
<html>
    <head>
        <title>Tony's 错题本</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">  
        <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
        <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="thirdparty/vue.min.js"></script>
    </head>
    <body>

        <table width="100%">
            <tr>
                <td width="70">
                    <div class="btn-group" style="margin-right: 20px">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">三
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu" style="font-size: 24px">
                            <li><a href="/static/add_wrong_character.html">录入-别字</a></li>
                            <li><a href="/static/add_wrong_pinyin.html">录入-拼音</a></li>
                            <li><a href="/static/add_choice_question_text.html">录入-选择题(纯文本)</a></li>
                            <li class="divider"></li>
                            <li><a href="/static/list_learning.html">学习中的错题</a></li>
                            <li class="divider"></li>
                            <li><a href="/static/user.html">用户</a></li>
                            <li><a href="/static/about.html">关于</a></li>
                        </ul>
                    </div>
                </td>
                <td>
                    <button type="button" class="btn btn-block btn-primary" onclick="location.reload()">刷下一题 (剩余:{{rest_count}})</button>
                </td>
                <td width="10px" style="padding-left:5px; max-width:100px"><label>[{{user}}]</label></td>
            </tr>
        </table>

        <div id="id_question_choice">
            <style>
                #id_question_choice { font-size:30px }
                #id_question_choice button { font-size:30px; padding-left: 40px; padding-right: 40px }
                #id_question_content>img { padding-bottom: 10px; }
                #id_choices { margin-left: 40px }
                #id_choices .checkbox input { zoom:200% }
            </style>
            <p id="id_question_content"></p>
            <div id="id_choices"></div>
            <button type="button" class="btn btn-success" onclick="submitChoiceAnswer()">提交</button>
            <label id="id_result_right" class="text-success" hidden>正确</label>
            <label id="id_result_wrong" class="text-danger" hidden>错误</label>
            <br/><label id="id_result_detail" class="text-info"></label>
        </div>

        <script>
            var vm = new Vue({
                el: "body",
                data: {
                    rest_count: "加载中...",
                    user: "",
                },
                methods: {
                }
            });

            var question_id;
            $(document).ready(function() {
                // 获取用户名
                var cookies = document.cookie.split(";")[0].split("=");
                if (cookies.length == 2 && cookies[0] == 'user') vm.user = cookies[1];
                else location.href = "/static/user.html";
                // 只要经常用，则cookie一直有效
                var exp = new Date();
                exp.setTime(exp.getTime() + 30*24*60*60*1000);
                document.cookie = "user="+vm.user+";expires="+exp.toGMTString();

                $.ajax({
                    url : "/rest/get_next_question?user="+vm.user,
                    dataType : "json",
                    success: function (data) {
                        if (data.result != "ok") {
                            alert(data.result)
                            return;
                        }
                        vm.rest_count = data.rest_count;
                        if (!data.rest_count) {
                            $("#id_question_content").html("任务完成");
                            $("#id_question_choice>button").attr("disabled","disabled");
                            return;
                        }
                        var info = data.question_info;
                        question_id = info.id
                        $("#id_question_content").html(info.question.replace(/\?\?/g, '<img src="tianzige.png">') + "<br>请选择:");
                        for (var i = 0; i < info.choices.length; i++){
                            var html = '<div class="checkbox"><label><input type="checkbox" value="' + info.choices[i] + '">' + info.choices[i] + '</label></div>';
                            $("#id_choices").append(html);
                        }
                    },
                    error: function (data) {
                        alert(data.result);
                    }
                });
            });

            function submitChoiceAnswer() {
                var chosen = "";
                $("#id_choices input:checked").each(function() {
                    chosen += $(this).attr("value") + ","
                });
                if (chosen.length == 0) return;
                chosen = chosen.substr(0, chosen.length - 1);
                $("#id_question_choice button").attr("disabled","disabled");
                $.ajax({
                    url : "/rest/submit_answer?id="+question_id+"&user="+vm.user+"&chosen="+chosen,
                    dataType : "json",
                    success: function (data) {
                        if (data.result != "ok") {
                            alert(data.result)
                            return;
                        }
                        if (data.correct) $("#id_result_right").show();
                        else $("#id_result_wrong").show();
                        $("#id_result_detail").html(data.detail);
                    }
                });
            }
        </script>
    </body>
</html>
